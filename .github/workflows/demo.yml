name: Demo

on:
  pull_request:
    types: [opened, reopened, synchronize, labeled]
  pull_request_target:
    types: [opened, reopened, synchronize, labeled]

jobs:
  demo:
    if: github.event_name == 'pull_request'
    # if: ${{ github.event.label.name == 'run-benchmark' && github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch' }}
    name: Linux
    runs-on: ubuntu-20.04

    steps:
      - uses: actions/checkout@v2

      - name: Do something
        run: |
          sleep 10

  demo_report:
    if: github.event_name == 'pull_request_target'
    # if: ${{ github.event.label.name == 'run-benchmark' && github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch' }}
    name: Report
    runs-on: ubuntu-20.04
    steps:
      - name: Find run id of demo and post log URL
        id: demo_id
        uses: actions/github-script@v4
        with:
          script: |
            const { data: thisRun } = await github.actions.getWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: ${{ github.run_id }},
            })

            const { data: runs } = await github.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: "demo.yml",
                event: "pull_request",
              })

            const workflow_runs = runs.workflow_runs;
            workflow_runs.sort((a, b) => a.created_at.localeCompare(b.created_at))
            for (const run of workflow_runs){
                if (thisRun.head_sha == run.head_sha && run.id != thisRun.id){
                    var lastRun = run;
                }
            }

            github.issues.createComment({
              issue_number: ${{ github.event.number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `Benchmarks are running! Check [logs here](${ lastRun.html_url }).`
            })